stages:
  - schedule
  - test
  - prebuild
  - build
  - sec-scan
  - pages
  - distribute
  - deploy

variables:
  KANIKO_USE_CACHE: 'yes'

include:
  - project: 'symbic-intern/symbic-templates'
    file: '/GitlabCI/kaniko-build.yml'
  - project: 'symbic-intern/symbic-templates'
    file: '/GitlabCI/kaniko-build-ingress.yml'

image-build-playbooks:
  extends: .build_template
  variables:
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
  rules:
    - if: $CI_COMMIT_REF_NAME
      changes:
        - roles/**/*
        - shared/**/*
        - pb_*
        - Dockerfile
        - requirements.txt
        - ansible-entrypoint.sh
    - if: $CI_COMMIT_TAG

image-build-ingress-genarator:
  extends: .build_template
  variables:
    DOCKERFILE: $CI_PROJECT_DIR/ingress-generator/Dockerfile
    CONTEXT: $CI_PROJECT_DIR/ingress-generator/
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE/ingress-genarator:$CI_COMMIT_REF_NAME
  rules:
    - if: $CI_COMMIT_REF_NAME
      changes:
        - ingress-generator/**/*
    - if: $CI_COMMIT_TAG

ingress-test-image-prebuild:
  extends: .ingress_image_prebuild
  variables:
    INGRESS_BASE_DIR: $CI_PROJECT_DIR/ingress-generator
    INGRESS_DOCKERFILE: $INGRESS_BASE_DIR/Dockerfile.test.nginx
  rules:
    - if: $CI_COMMIT_REF_NAME
      changes:
        - ingress-generator/**/*

ingress-test-image-build:
  extends: .ingress_image_build
  variables:
    INGRESS_BASE_DIR: $CI_PROJECT_DIR/ingress-generator
    INGRESS_DOCKERFILE: $INGRESS_BASE_DIR/Dockerfile.test.nginx
    INGRESS_IMAGE_NAME: $CI_REGISTRY_IMAGE/ingress-test-image
  rules:
    - if: $CI_COMMIT_REF_NAME
      changes:
        - ingress-generator/**/*
