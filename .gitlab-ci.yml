variables:
  ANSIBLE_DOACKER_IMAGE: python:3.9-bullseye
  KANIKO_USE_CACHE: 'yes'

include:
  - project: 'symbic-intern/symbic-templates'
    file: '/GitlabCI/kaniko-build.yml'

stages:
  - build

image-build-playbooks-tags:
  extends: .build_template
  variables:
    COMMIT_TAG: $CI_COMMIT_TAG
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG

image-build-playbooks-branch:
  extends: .build_template
  variables:
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH

image-build-ingress-genarator:
  extends: .build_template
  variables:
    DOCKERFILE: $CI_PROJECT_DIR/conf/ingress/Dockerfile
    CONTEXT: $CI_PROJECT_DIR/conf/ingress/
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE/ingress-genarator:$CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - conf/ingress/ingress-hosts-nginx.yml
        - conf/ingress/ingress-hosts-traefik.yml
        - conf/ingress/generate-ingress-conf.js
        - conf/ingress/Dockerfile
        - conf/ingress/nginx-site.conf.j2
        - conf/ingress/my-entrypoint.sh.j2
        - conf/ingress/nginx-site-http-only.conf.j2

image-build-ingress-tester:
  extends: .build_template
  variables:
    DOCKERFILE: $CI_PROJECT_DIR/conf/ingress/Dockerfile.test
    CONTEXT: $CI_PROJECT_DIR/conf/ingress/
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE/ingress-genarator:$CI_COMMIT_BRANCH
    KANIKO_NO_PUSH: "yes"
    KANIKO_USE_CACHE: "no"
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - conf/ingress/ingress-hosts-nginx.yml
        - conf/ingress/ingress-hosts-traefik.yml
        - conf/ingress/generate-ingress-conf.js
        - conf/ingress/Dockerfile
        - conf/ingress/Dockerfile.test
        - conf/ingress/nginx-site.conf.j2
        - conf/ingress/my-entrypoint.sh.j2
        - conf/ingress/nginx-site-http-only.conf.j2
