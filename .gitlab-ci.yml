variables:
  GIT_SUBMODULE_STRATEGY: recursive
  ANSIBLE_DOACKER_IMAGE: python:3.9-bullseye

include:
  - project: 'symbic-intern/symbic-templates'
    file: '/GitlabCI/kaniko-build.yml'

stages:
  - build

build_tags:
  extends: .build_template
  variables:
    COMMIT_TAG: $CI_COMMIT_TAG
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG

build_branch:
  extends: .build_template
  variables:
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - Dockerfile

# create-hetzner-snapshot:
#   stage: backup
#   image: $DOCKER_IMAGE_NODE
#   retry: 2
#   script:
#     - cd hetzner-snapshots
#     - export HETZNER_API_KEY=$(printenv | grep ${PROJECT_TOKEN_NAME}= | awk -F "=" '{print $2}' | tr -d '\n')
#     - node snapshot.js
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "schedule"'
#     - if: '$CI_PIPELINE_SOURCE == "api"'
#     - if: '$PROJECT_TOKEN_NAME == ""'
#       when: never