variables:
  KANIKO_USE_CACHE: 'yes'

include:
  - project: 'symbic-intern/symbic-templates'
    file: '/GitlabCI/kaniko-build.yml'

stages:
  - build

image-build-playbooks-tag:
  extends: .build_template
  variables:
    COMMIT_TAG: $CI_COMMIT_TAG
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG

image-build-playbooks-branch:
  extends: .build_template
  variables:
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - roles/**/*
        - shared/**/*
        - pb_*
        - Dockerfile
        - requirements.txt

image-build-ingress-genarator:
  extends: .build_template
  variables:
    DOCKERFILE: $CI_PROJECT_DIR/ingress-generator/Dockerfile
    CONTEXT: $CI_PROJECT_DIR/ingress-generator/
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE/ingress-genarator:$CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - ingress-generator/**/*

image-build-ingress-tester:
  extends: .build_template
  variables:
    DOCKERFILE: $CI_PROJECT_DIR/ingress-generator/Dockerfile.test.nginx
    CONTEXT: $CI_PROJECT_DIR/ingress-generator/
    BUILD_IMAGE_TAG: $CI_REGISTRY_IMAGE/ingress-genarator:$CI_COMMIT_BRANCH
    KANIKO_NO_PUSH: "yes"
    KANIKO_USE_CACHE: "no"
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - ingress-generator/**/*
