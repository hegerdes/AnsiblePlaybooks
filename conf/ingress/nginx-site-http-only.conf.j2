# Conf for {{ nginx_vhost.host }}

{% if(nginx_vhost.upstreams | default([]) | length != 0) -%}
# Upstream targets
    {% for upstream in nginx_vhost.upstreams | default([]) -%}
    {% if(upstream.targets | default([]) | length != 0) %}
    upstream {{ nginx_vhost.host }}_{{ upstream.name }} {
        {% for target in upstream.targets | default([]) -%}
            server {{ target }};
        {% endfor %}
    }
    {% endif %}
    {% endfor %}
{% endif %}

# HTTP server
server {
    listen      80;
    listen      [::]:80;
    server_name {{ nginx_vhost.host }};

    # Sever settings for all sites
    {{ ingress_hosts.nginx.common_server_settings | default("# None") | safe | indent(4) }}
    # Sever settings per site
    {{ nginx_vhost.nginx.server_settings | default("# None") | safe | indent(4) }}

    # ACME-challenge
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/_letsencrypt;
    }

    # Locations
    {% for location in nginx_vhost.nginx.locations | default([]) %}
    # Custom locations
    location {{ location.route }} {
        {{ nginx_settings.common_header | safe | trim | indent(8) if (nginx_settings.common_header) }}
        {{ location.body | safe | indent(8) }}
    }
    {% endfor %}

    {%- if nginx_vhost.nginx.locations | default([]) | length == 0 -%}
    # Default location
    location {{ nginx_settings.common_location_prefix | default("/") }} {
        {{ nginx_settings.common_header | safe | trim | indent(8) if (nginx_settings.common_header) }}
        proxy_pass http://{{ nginx_vhost.host }}_upstream/{{ nginx_settings.common_proxypass_suffix | default("") }};
    }
    {% endif %}

    # Shared server settings
    include shared.conf/general.conf;
}
