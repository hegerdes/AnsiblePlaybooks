#!/bin/bash

# Start cron
echo "Starting cron"
cron

# Start nginx
sh /docker-entrypoint.sh nginx -g "daemon off;" &
MAIN_PID=$!

MAIL=<%if (conf && conf.certbot_mail) {-%>  <%=conf.certbot_mail%> <%} else {%>"info@xyz.de"<%}%>
DOMAINS=(<%for(let site of sites){-%> <%=site.host%><%}-%>)

# Start init certbot if set
if [ $RUN_CERTBOT = "yes" ]; then
    for DOMAIN in "${DOMAINS[@]}"; do
        echo "Generating cert for ${DOMAIN}"
        certbot --nginx -d $DOMAIN --agree-tos --non-interactive -m $MAIL
    done
fi

# Wait for nginx to exit
wait $MAIN_PID
