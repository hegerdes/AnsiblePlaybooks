- name: Reset Kubernetes component
  shell: "kubeadm reset --force"
  register: reset_cluster
  tags: [k8s, k8-init, k8-master-init]

- name: Init Kubernetes cluster
  when: reset_cluster is succeeded
  shell: |
    kubeadm init --kubernetes-version={{ k8s_version }} \
                 --pod-network-cidr {{ k8s_pod_network_cidr }} \
                 --token {{ k8s_token }} \
                 --upload-certs \
                 --ignore-preflight-errors=NumCPU \
                 --apiserver-advertise-address {{ k8s_api_server }} \
                 --apiserver-cert-extra-sans={{ k8s_cert_extra_sans }}
                 {{ k8s_kubeadm_opts }} \
                 {{ k8s_init_opts }}
  register: init_cluster
  tags: [k8s, k8-init, k8-master-init]

- name: Remove no NoSchedule taint form master nodes
  kubernetes.core.k8s_taint:
    kubeconfig: /etc/kubernetes/admin.conf
    state: absent
    name: '{{ ansible_facts.hostname }}'
    taints:
    - key: node-role.kubernetes.io/control-plane
      effect: NoSchedule
    - key: dedicated
  tags: [k8s, k8-init, k8-master-init, k8-taint]

- name: debug
  debug:
    var: init_cluster


# kubeadm init --kubernetes-version stable-1 \
#              --pod-network-cidr 10.244.0.0/16 \
#              --token xzqdcd.qwgaj3p6da3xx931 \
#              --upload-certs \
#              --ignore-preflight-errors=NumCPU \
#              --apiserver-advertise-address 10.10.0.2 \
#              --apiserver-cert-extra-sans=127.0.0.1,10.10.0.2,10.10.0.1,116.203.124.54