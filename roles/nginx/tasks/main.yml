# Main Nginx Setup
---
- name: Set floating IPs
  when: ingress_floating_ips | length > 0
  import_tasks: shared/set-floting-ip.yml
  vars:
    floating_ips: '{{ common_floating_ips | default([]) + ingress_floating_ips }}'
  tags: [ingress, nginx, ingress-ip]

- name: Install nginx
  import_tasks: install-nginx.yml
  tags: [ingress, nginx]

- name: Ensure handlers are notified now
  meta: flush_handlers
  tags: [ingress, nginx]

- name: Setup nginx routes
  when: nginx_install_hosts | bool
  import_tasks: setup-nginx-routes.yml
  tags: [ingress, nginx, ingress-hosts]

- name: Start nginx
  import_tasks: start-nginx.yml
  tags: [ingress, nginx, ingress-hosts]

- name: Setup firewall
  include_role:
    name: firewalld
  vars:
    firwalld_rules: '{{ nginx_default_firewall_rules + nginx_firewall_rules }}'
  tags: [ingress, nginx, firewall]

- name: Ensure handlers are notified now
  meta: flush_handlers
  tags: [ingress, nginx, firewall]

- name: Setup cron jobs
  when: nginx_run_certbot | bool
  import_tasks: shared/install-cron-jobs.yml
  tags: [ingress, nginx, cron]
  vars:
    cron_jobs: '{{ nginx_cron_jobs }}'

- name: Ensure handlers are notified now
  meta: flush_handlers
  tags: [ingress, nginx]