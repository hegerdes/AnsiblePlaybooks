# Upstream target

    upstream {{ nginx_vhost.host }}_upstream {
        {{ ["server "] | product(nginx_vhost.upstreams | default([])) | map('join') | list | product([";"]) | map('join') | list | join("\n") | indent(width=8) }}
    }

{{ nginx_vhost.upstream | default("# No upsteam set") }}

# Server
server {
    # Server-name will be domain name
    server_name {{ nginx_vhost.host }};

    # Sever settings for all sites
    {{ ingress_hosts.nginx.common_server_settings | default("# None") | indent(width=4) }}
    # Sever settings per site
    {{ nginx_vhost.nginx.server_settings | default("# None") | indent(width=4) }}

    # ACME-challenge
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/_letsencrypt;
    }

{% for location in nginx_vhost.nginx.locations | default([]) %}
    location {{ location.route }} {
        {{ nginx_settings.common_header | trim | indent(width=8) if (nginx_settings.common_header) }}
        {{ location.body | indent(width=8) }}
    }
{% endfor %}

{% if nginx_vhost.nginx.locations | default([]) | length == 0 %}
    location / {
        {{ nginx_settings.common_header | trim |indent(width=8) if (nginx_settings.common_header) }}
        proxy_pass http://{{ nginx_vhost.host }}_upstream/;
    }
{% endif %}

    listen {{ nginx_vhost.ip + ":" if(not nginx_use_docker) }}443 ssl http2; # managed by Certbot
    ssl_certificate {{ nginx_cert_paths[nginx_vhost.host].crt | default("/etc/letsencrypt/dummy/fullchain.pem") }}; # managed by Certbot
    ssl_certificate_key {{ nginx_cert_paths[nginx_vhost.host].key | default("/etc/letsencrypt/dummy/privkey.pem") }}; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Shared sec settings
    include shared.conf/security.conf;
    # Shared server settings
    include shared.conf/general.conf;
}

# HTTP redirect
server {
    listen      {{ nginx_vhost.ip }}:80;
    listen      [::]:80;
    server_name {{ nginx_vhost.host }};

    # ACME-challenge
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/_letsencrypt;
    }

    location / {
        return 301 https://{{ nginx_vhost.host }}$request_uri;
    }

    # Shared server settings
    include shared.conf/general.conf;
}
