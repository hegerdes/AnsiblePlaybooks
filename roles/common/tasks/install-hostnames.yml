# Set alias in etc/hosts
---
- name: Create hosts dictionary
  set_fact:
    etc_hosts: '{{ etc_hosts | default({}) | combine ({ item : hostvars[item].ansible_host }) }}'
  loop: '{{ ansible_play_hosts_all }}'
  tags: [common, hostnames]

- name: Add autogenerated hosts to /etc/hosts
  lineinfile:
     path: /etc/hosts
     line: '{{ item.value }} {{ item.key }}'
     create: yes
  with_dict: '{{ etc_hosts }}'
  tags: [common, hostnames]

- name: Add user hosts to /etc/hosts
  lineinfile:
     path: /etc/hosts
     line: '{{ item.1 }} {{ item.0.name }}'
     create: yes
  loop: '{{ internal_hostnames | subelements("ips") }}'
  loop_control:
    label: '{{ item.0.name }}'
  tags: [common, hostnames]

- name: Setting host keys
  lineinfile:
    create: yes
    path: /root/.ssh/known_hosts
    line: "{{ item }}"
  loop: '{{ all_hostkeys | default([]) }}'
  loop_control:
    label: '{{ item[:20] }}'
  tags: [common, hostnames]
